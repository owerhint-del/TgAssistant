{% extends "base.html" %}

{% block title %}TgAssistant â€” Settings{% endblock %}
{% block nav_setup %}font-semibold text-gray-900{% endblock %}

{% block content %}
<div x-data="setupApp()" x-init="init()">

    <!-- Telegram Auth -->
    <div class="bg-white rounded-xl border border-gray-200 p-5 mb-6">
        <h2 class="text-base font-semibold mb-4">Telegram Authorization</h2>

        <!-- Status indicator -->
        <div class="mb-4 flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full" :class="authStatus.authorized ? 'bg-green-500' : 'bg-gray-300'"></span>
            <span class="text-sm" x-text="authStatus.authorized
                ? 'Authorized as ' + authStatus.user
                : 'Not authorized'"></span>
        </div>

        <!-- Step 1: Phone -->
        <div x-show="authStep === 'phone'">
            <form @submit.prevent="sendCode()" class="flex flex-col sm:flex-row gap-3">
                <input type="tel" x-model="phone"
                       placeholder="+49123456789"
                       class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                <button type="submit" :disabled="authLoading"
                        class="px-6 py-2.5 bg-brand-600 text-white text-sm font-medium rounded-lg
                               hover:bg-brand-700 disabled:opacity-50 transition-colors whitespace-nowrap">
                    <span x-show="!authLoading">Send Code</span>
                    <span x-show="authLoading">Sending...</span>
                </button>
            </form>
        </div>

        <!-- Step 2: Code verification -->
        <div x-show="authStep === 'code'">
            <p class="text-sm text-gray-500 mb-3">Enter the code sent to <span class="font-medium" x-text="phone"></span></p>
            <form @submit.prevent="verifyCode()" class="flex flex-col sm:flex-row gap-3">
                <input type="text" x-model="code"
                       placeholder="12345"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-mono tracking-widest
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                <button type="submit" :disabled="authLoading"
                        class="px-6 py-2.5 bg-brand-600 text-white text-sm font-medium rounded-lg
                               hover:bg-brand-700 disabled:opacity-50 transition-colors whitespace-nowrap">
                    Verify
                </button>
            </form>
            <button @click="authStep = 'phone'" class="mt-2 text-xs text-gray-400 hover:text-gray-600">
                Use different number
            </button>
        </div>

        <!-- Step 3: 2FA password -->
        <div x-show="authStep === '2fa'">
            <p class="text-sm text-gray-500 mb-3">Two-factor authentication is enabled. Enter your cloud password.</p>
            <form @submit.prevent="verify2FA()" class="flex flex-col sm:flex-row gap-3">
                <input type="password" x-model="password2fa"
                       placeholder="Cloud password"
                       class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                <button type="submit" :disabled="authLoading"
                        class="px-6 py-2.5 bg-brand-600 text-white text-sm font-medium rounded-lg
                               hover:bg-brand-700 disabled:opacity-50 transition-colors whitespace-nowrap">
                    Verify
                </button>
            </form>
        </div>

        <!-- Auth error -->
        <p x-show="authError" x-text="authError" class="mt-3 text-sm text-red-600"></p>
        <!-- Auth success -->
        <p x-show="authSuccess" x-text="authSuccess" class="mt-3 text-sm text-green-600"></p>
    </div>

    <!-- Settings -->
    <div class="bg-white rounded-xl border border-gray-200 p-5">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold">Settings</h2>
            <button @click="saveConfig()" :disabled="saving"
                    class="px-4 py-2 bg-brand-600 text-white text-sm font-medium rounded-lg
                           hover:bg-brand-700 disabled:opacity-50 transition-colors">
                <span x-show="!saving">Save</span>
                <span x-show="saving">Saving...</span>
            </button>
        </div>

        <div class="space-y-5">
            <!-- Phone -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone number</label>
                <input type="tel" x-model="config.tg_phone"
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                <p class="mt-1 text-xs text-gray-400">Used for Telegram auth</p>
            </div>

            <!-- API Key -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Anthropic API Key</label>
                <input type="password" x-model="config.anthropic_api_key"
                       placeholder="sk-ant-..."
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
            </div>

            <!-- Output dir -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Output directory</label>
                <input type="text" x-model="config.output_dir"
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                <p class="mt-1 text-xs text-gray-400">Where PDF files are saved</p>
            </div>

            <div class="border-t border-gray-100 pt-5">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Pipeline</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Whisper model -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Whisper model</label>
                        <select x-model="config.whisper_model"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm
                                       focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="tiny">tiny (fastest)</option>
                            <option value="base">base</option>
                            <option value="small">small</option>
                            <option value="medium">medium</option>
                            <option value="large-v3">large-v3 (best)</option>
                        </select>
                    </div>

                    <!-- Whisper language -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Audio language</label>
                        <select x-model="config.whisper_language"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm
                                       focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="ru">Russian</option>
                            <option value="en">English</option>
                            <option value="de">German</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                        </select>
                    </div>

                    <!-- Output dir -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Output directory</label>
                        <input type="text" x-model="config.output_dir"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm
                                      focus:ring-2 focus:ring-brand-500 outline-none"
                               placeholder="~/Documents/TgAssistant">
                    </div>
                </div>
            </div>
        </div>

        <!-- Save feedback -->
        <p x-show="saveError" x-text="saveError" class="mt-3 text-sm text-red-600"></p>
        <p x-show="saveSuccess" class="mt-3 text-sm text-green-600">Settings saved!</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setupApp() {
    return {
        // Auth state
        authStatus: {authorized: false},
        authStep: 'phone',
        authLoading: false,
        authError: '',
        authSuccess: '',
        phone: '',
        code: '',
        password2fa: '',

        // Config state
        config: {},
        saving: false,
        saveError: '',
        saveSuccess: false,

        async init() {
            await Promise.all([
                this.checkAuth(),
                this.loadConfig(),
            ]);
            // Pre-fill phone from config
            if (this.config.tg_phone) {
                this.phone = this.config.tg_phone;
            }
        },

        async checkAuth() {
            try {
                const resp = await fetch('/api/auth/status');
                this.authStatus = await resp.json();
                if (this.authStatus.authorized) {
                    this.authStep = 'done';
                }
            } catch (e) {
                console.error('Auth check failed:', e);
            }
        },

        async sendCode() {
            this.authLoading = true;
            this.authError = '';
            try {
                const resp = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone: this.phone}),
                });
                const data = await resp.json();
                if (data.success) {
                    this.authStep = 'code';
                } else {
                    this.authError = data.error;
                }
            } catch (e) {
                this.authError = 'Network error';
            }
            this.authLoading = false;
        },

        async verifyCode() {
            this.authLoading = true;
            this.authError = '';
            try {
                const resp = await fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone: this.phone, code: this.code}),
                });
                const data = await resp.json();
                if (data.needs_2fa) {
                    this.authStep = '2fa';
                } else if (data.authorized) {
                    this.authSuccess = 'Authorized as ' + data.user;
                    this.authStatus = {authorized: true, user: data.user};
                    this.authStep = 'done';
                } else {
                    this.authError = data.error || 'Verification failed';
                }
            } catch (e) {
                this.authError = 'Network error';
            }
            this.authLoading = false;
        },

        async verify2FA() {
            this.authLoading = true;
            this.authError = '';
            try {
                const resp = await fetch('/api/auth/verify-2fa', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: this.password2fa}),
                });
                const data = await resp.json();
                if (data.authorized) {
                    this.authSuccess = 'Authorized as ' + data.user;
                    this.authStatus = {authorized: true, user: data.user};
                    this.authStep = 'done';
                } else {
                    this.authError = data.error || '2FA verification failed';
                }
            } catch (e) {
                this.authError = 'Network error';
            }
            this.authLoading = false;
        },

        async loadConfig() {
            try {
                const resp = await fetch('/api/config');
                this.config = await resp.json();
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        },

        async saveConfig() {
            this.saving = true;
            this.saveError = '';
            this.saveSuccess = false;
            try {
                const resp = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.config),
                });
                const data = await resp.json();
                if (data.success) {
                    this.saveSuccess = true;
                    setTimeout(() => this.saveSuccess = false, 3000);
                } else {
                    this.saveError = data.error || 'Save failed';
                }
            } catch (e) {
                this.saveError = 'Network error';
            }
            this.saving = false;
        },
    };
}
</script>
{% endblock %}
